# Sidekick Protocol Specification

Sidekick is a standalone service that manages WebSocket connections on behalf of a Covenant server. It enables realtime channels and resource invalidation for deployments where the application server cannot hold WebSocket connections (e.g., edge/serverless environments).

Sidekick communicates with two parties:
- **Server** (the Covenant application server) via HTTP
- **Clients** (browsers/frontends) via WebSocket

All messages are serialized with [ION](../ion), Covenant's binary serialization format.

## Authentication

### Server-to-Sidekick

All HTTP endpoints require a shared secret passed as a Bearer token:

```
Authorization: Bearer <secret>
```

Failed authentication returns `401 Unauthorized` after a deliberate delay.

### Client-to-Sidekick

Clients do not authenticate at WebSocket connection time. Instead, the server issues opaque tokens that clients present to Sidekick to prove they are authorized for a specific channel subscription. See [Token Lifecycle](#token-lifecycle) for details.

## HTTP Endpoints (Server to Sidekick)

### `POST /connection`

Registers a new channel connection token. The server calls this after a client requests a channel connection and the server's `onConnect` handler succeeds.

**Request body** (ION):

```typescript
{
  token: string                      // Opaque token generated by the server
  channel: string                    // Channel name
  params: Record<string, string>     // Channel parameters (e.g., { roomId: "123" })
  context: unknown                   // Server-generated context (e.g., auth/user data)
}
```

**Response**: `200 OK`

### `POST /resources`

Notifies Sidekick that resources have been updated. Sidekick broadcasts `updated` messages to all clients listening on those resources.

**Request body** (JSON):

```typescript
{
  resources: string[]    // Resource identifiers (e.g., ["todo/123", "user/456"])
}
```

**Response**: `200 OK`

### `POST /message`

Sends a message from the server to all clients subscribed to a channel+params combination.

**Request body** (ION):

```typescript
{
  channel: string                    // Channel name
  params: Record<string, string>     // Channel parameters
  data: unknown                      // Message payload
}
```

**Response**: `200 OK`

## WebSocket Protocol (Client to Sidekick)

Clients connect to `/socket`. All messages in both directions are ION-serialized strings.

### Client-to-Sidekick Messages

#### `subscribe`

Activates a channel subscription using a token obtained from the server.

```typescript
{
  type: "subscribe"
  token: string
}
```

#### `unsubscribe`

Deactivates a channel subscription.

```typescript
{
  type: "unsubscribe"
  token: string
}
```

#### `send`

Sends a message through a channel back to the server. Can be used both before and after subscribing, as long as the token is valid.

```typescript
{
  type: "send"
  token: string
  channel: string
  params: Record<string, string>
  data: unknown
}
```

#### `listen`

Subscribes to resource update notifications (independent of channels).

```typescript
{
  type: "listen"
  resources: string[]
}
```

#### `unlisten`

Unsubscribes from resource update notifications.

```typescript
{
  type: "unlisten"
  resources: string[]
}
```

### Sidekick-to-Client Messages

#### `subscribed`

Confirms a successful channel subscription.

```typescript
{
  type: "subscribed"
  channel: string
  params: Record<string, string>
}
```

#### `unsubscribed`

Confirms a channel unsubscription.

```typescript
{
  type: "unsubscribed"
  channel: string
  params: Record<string, string>
}
```

#### `message`

Delivers a server-originated channel message.

```typescript
{
  type: "message"
  channel: string
  params: Record<string, string>
  data: unknown
}
```

#### `listening`

Confirms resource listen registration.

```typescript
{
  type: "listening"
  resources: string[]
}
```

#### `unlistening`

Confirms resource listen removal.

```typescript
{
  type: "unlistening"
  resources: string[]
}
```

#### `updated`

Notifies the client that a resource has been invalidated.

```typescript
{
  type: "updated"
  resource: string
}
```

#### `error`

Reports an error to the client.

```typescript
{
  type: "error"
  error: {
    channel: string
    params: Record<string, string>
    fault: "server" | "client" | "sidekick"
    message: string
  }
}
```

## Topic Naming

Sidekick uses an internal pub/sub system. Topics are formatted as:

- **Channel topics**: `channel:<name>/<key1>:<value1>,<key2>:<value2>`
  - Example: `channel:chat/roomId:123`
- **Resource topics**: `resource:<id>`
  - Example: `resource:todo/456`

## Token Lifecycle

Tokens enable secure, scoped channel subscriptions without requiring clients to authenticate directly with Sidekick.

1. **Client requests a channel connection** from the application server (via the normal RPC layer).
2. **Server validates the request** (runs `onConnect` handler), generates a token, and sends a `ChannelConnectionPayload` to Sidekick via `POST /connection`. The server returns the token to the client in a `ChannelConnectionResponse`.
3. **Token is stored** in Sidekick's `tokenMap`, associated with the channel, params, and server-generated context.
4. **Client sends `subscribe`** with the token over WebSocket. Sidekick validates the token, moves it from `tokenMap` to `usedTokenMap` (binding it to the client's WebSocket ID), stores the context, and subscribes the client to the channel topic.
5. **Client can send messages** using the token. Sidekick retrieves the stored context and forwards the message (with context) to the server for processing.
6. **Client sends `unsubscribe`** to tear down. Sidekick removes the token from `usedTokenMap` and cleans up stored context.

## Sidekick-to-Server Communication

When a client sends a `send` message, Sidekick forwards it to the application server with the stored context attached:

```typescript
{
  channel: string
  params: Record<string, string>
  data: unknown
  context: unknown    // The context originally provided in POST /connection
}
```

The server processes the message using its channel's `onMessage` handler and may return a `ChannelError` if something goes wrong, which Sidekick relays back to the client as an `error` message.

## Connection Interfaces

Implementations must satisfy these interfaces (defined in `interfaces.ts`):

```typescript
// Server calls these to talk to Sidekick
interface ServerToSidekickConnection {
  addConnection(payload: ChannelConnectionPayload): Promise<Error | null>
  update(resources: string[]): Promise<Error | null>
  postMessage(message: ServerMessage): Promise<Error | null>
}

// Client calls these to talk to Sidekick
interface ClientToSidekickConnection {
  sendMessage(message: SidekickIncomingMessage): void
  onMessage(handler: (m: SidekickOutgoingMessage) => MaybePromise<void>): () => void
}

// Sidekick calls this to relay client messages back to the server
interface SidekickToServerConnection {
  sendMessage(message: ServerMessageWithContext): Promise<ChannelError | null>
}
```

## Adapter Requirements

To implement Sidekick for a new web framework, the adapter must:

1. **Expose the three HTTP endpoints** (`/connection`, `/resources`, `/message`) with Bearer token auth.
2. **Expose a WebSocket endpoint** (`/socket`) that deserializes ION messages, delegates to `Sidekick.handleClientMessage()`, and wires up a `SidekickClient` that maps to the framework's WebSocket pub/sub primitives.
3. **Provide a publish function** to the `Sidekick` constructor that broadcasts an ION-serialized message to all subscribers of a given topic.
4. **Implement `SidekickClient`** with `subscribe`, `unsubscribe`, `getId`, and `directMessage` mapped to the framework's WebSocket API.

```typescript
interface SidekickClient {
  subscribe(topic: string): void
  unsubscribe(topic: string): void
  getId(): string
  directMessage(message: SidekickOutgoingMessage): void
}
```
